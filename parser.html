<!DOCTYPE html>
<html>

<head>
    <title>Demo Parser | nekzor.github.io</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>.link { color: white } .link:hover { color: aquamarine }</style>
</head>

<body class="white-text blue-grey darken-4">
    <nav class="nav-extended blue-grey darken-3">
        <div class="nav-wrapper">
            <div class="col s12 hide-on-small-only">
                <a href="#" data-target="slide-out" class="sidenav-trigger show-on-large"><i class="material-icons">menu</i></a>
                <a href="index.html">&nbsp;&nbsp;&nbsp;nekzor.github.io</a>
                <a class="breadcrumb"></a>
                <a href="parser.html">Demo Parser</a>
            </div>
            <div class="col s12 hide-on-med-and-up">
                <a href="#" data-target="slide-out" class="sidenav-trigger"><i class="material-icons">menu</i></a>
                <a href="parser.html" class="brand-logo center">DP</a>
            </div>
        </div>
        <div class="nav-content">
            <ul class="tabs tabs-transparent">
                <li class="tab"><a href="#info">Info</a></li>
                <li class="tab"><a href="#list">List</a></li>
                <li class="tab"><a href="#view">View</a></li>
                <li class="tab"><a href="#about">About</a></li>
            </ul>
        </div>
    </nav>
    <ul id="slide-out" class="sidenav">
        <li><a href="index.html">nekzor.github.io</a></li>
        <li><a href="glitches.html">Glitches</a></li>
        <li><a href="lp.html">Least Portals</a></li>
        <li><a href="parser.html">Demo Parser</a></li>
    </ul>
    <div id="info" ondrop="dropHandler(event)" ondragover="dragOverHandler(event)">
        <div class="row"></div>
        <div class="row">
            <div class="col s12 m12 l2 push-l2">
                <div class="file-field input-field">
                    <div class="btn-floating waves-effect waves-light green" title="Open File">
                        <i class="material-icons">folder_open</i>
                        <input id="add-info" type="file">
                        <div class="file-path-wrapper">
                            <input class="file-path validate white-text" type="text">
                        </div>
                    </div>
                    &nbsp;&nbsp;&nbsp;
                    <div id="add-info-view" class="btn-floating waves-effect waves-light green" title="Add To View">
                        <i class="material-icons">show_chart</i>
                    </div>
                </div>
            </div>
            <div class="col s12 m12 l6 push-l1 center-align">
                <h4 id="info-header"></h4>
            </div>
        </div>
        <div class="row">
            <div class="col s12 m12 l8 push-l2">
                <h3 id="info-header"></h3>
                <h5>Header</h5>
                <table>
                    <tbody id="info-header-entries"></tbody>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="col s12 m12 l8 push-l2">
                <h5>Commands</h5>
                <table>
                    <tbody id="info-commands-entries"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="list" ondrop="dropHandler(event)" ondragover="dragOverHandler(event)">
        <div class="row"></div>
        <div class="row">
            <div class="col s12 m12 l8 push-l2">
                <table>
                    <thead>
                        <tr>
                            <th>Map</th>
                            <th>Client</th>
                            <th>Ticks</th>
                            <th>Time</th>
                            <th>Total Ticks</th>
                            <th>Total Time</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="list-entries"></tbody>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="col s12 m12 l10 push-l2">
                <div class="file-field input-field">
                    <div class="btn-floating waves-effect waves-light green" title="Add Demo">
                        <i class="material-icons">add</i>
                        <input id="add-list-item" type="file" multiple>
                        <div class="file-path-wrapper">
                            <input class="file-path validate white-text" type="text">
                        </div>
                    </div>
                    &nbsp;&nbsp;&nbsp;
                    <div id="clear-list" class="btn-floating waves-effect waves-light green" title="Clear List">
                        <i class="material-icons">clear_all</i>
                    </div>
                    &nbsp;&nbsp;&nbsp;
                    <div id="save-list" class="btn-floating waves-effect waves-light green" title="Save List">
                        <i class="material-icons">save</i>
                    </div>
                </div>
                <div class="switch">
                    <label>
                        Sort by file name
                        <input id="change-sort-list-method" type="checkbox" checked>
                        <span class="lever"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>
    <div id="view" ondrop="dropHandler(event)" ondragover="dragOverHandler(event)">
        <div class="row"></div>
        <div class="row">
            <div class="col s12 m12 l8 push-l2">
                <div id="view-plot"></div>
            </div>
        </div>
        <div class="row">
            <div class="col s12 m12 l8 push-l2">
                <div class="file-field input-field">
                    <div class="btn-floating waves-effect waves-light green" title="Add Demo">
                        <i class="material-icons">add</i>
                        <input id="add-view" type="file" multiple>
                        <div class="file-path-wrapper">
                            <input class="file-path validate white-text" type="text">
                        </div>
                    </div>
                    &nbsp;&nbsp;&nbsp;
                    <div id="clear-view" class="btn-floating waves-effect waves-light green" title="Clear All">
                        <i class="material-icons">clear_all</i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="about">
        <div class="row">
            <div class="row"></div>
            <div class="row">
                <div class="col s12 m12 l10 push-l2">
                    <h3><a class="link" href="https://github.com/NeKzor/sdp.js">sdp.js</a></h3>
                    <p>
                        Experimental Source Engine demo parser for Node.js.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script type="text/javascript" src="js/browser.sdp.js"></script>
    <script type="text/javascript">
        M.Sidenav.init(document.querySelectorAll('.sidenav'), null);

        var tabs = M.Tabs.init(document.querySelector('.tabs'), null);
        var infoHeader = document.querySelector('#info-header');
        var infoHeaderEntries = document.querySelector('#info-header-entries');
        var infoCommandsEntries = document.querySelector('#info-commands-entries');
        var listEntries = document.querySelector('#list-entries');

        infoHeaderEntries.innerHTML = '-';
        infoCommandsEntries.innerHTML = '-';

        var demoParser = new sdp.SourceDemoParser();
        var defaultGame = new sdp.SourceGame();

        // Demo Parsing & Adjusting
        var tryParseDemo = (ev, fullAdjustment = true) => {
            let demo = null;
            try {
                console.log(`Parsing: ${ev.target.source.name}`);
                demo = demoParser.parseDemo(new Buffer(ev.target.result));
                demo.fileInfo = ev.target.source;

                demo.detectGame(defaultGame)
                    .adjustTicks(); // Fix message ticks

                if (fullAdjustment) {
                    demo.adjustment = {
                        ticks: {},
                        time: {},
                        delta: 0
                    };

                    demo.adjustRange(); // Fix header

                    demo.adjustment.ticks.before = demo.header.playbackTicks;
                    demo.adjustment.time.before = demo.header.playbackTime;

                    defaultGame.adjustByRules(demo); // Speedrun rules apply here

                    // Adjust 0-tick demos manually
                    if (demo.header.playbackTicks == 0) {
                        let ipt = demo.intervalPerTick();
                        // A TICK IS A TICK, YOU CAN'T SAY ITS NOTHING
                        demo.header.playbackTicks = 1;
                        demo.header.playbackTime = ipt;
                    }

                    demo.adjustment.ticks.after = demo.header.playbackTicks;
                    demo.adjustment.time.after = demo.header.playbackTime;
                    demo.adjustment.delta = Math.abs(demo.adjustment.ticks.before - demo.adjustment.ticks.after);
                }
            } catch (error) {
                console.error(error);
            }
            return demo;
        };
        var getAdjustmentResult = (demo) => {
            return {
                ticks: `
Adjusted by ${demo.adjustment.delta} tick${(demo.adjustment.delta == 1) ? '' : 's'}
Before: ${demo.adjustment.ticks.before}`,
                time: `
Adjusted by ${formatTime(demo.adjustment.delta * demo.intervalPerTick())}
Before: ${formatTime(demo.adjustment.time.before)}`
            };
        };

        // Info Tab
        var demo = null;
        var displayInfo = () => {
            if (demo != null) {
                let generateRows = (table, rows, setTitleName = true) => {
                    for (let row of rows) {
                        let entry = document.createElement('tr');
                        let name = document.createElement('td');
                        let data = document.createElement('td');
                        name.innerHTML = row[0];
                        data.innerHTML = row[1];
                        if (row.length == 3) {
                            if (setTitleName) {
                                name.setAttribute('title', row[2]);
                            } else {
                                data.setAttribute('title', row[2]);
                            }
                        }
                        entry.appendChild(name);
                        entry.appendChild(data);
                        table.appendChild(entry);
                    }
                };

                let header = [
                    ['Demo File Stamp', demo.header.demoFileStamp],
                    ['Demo Protocol', demo.header.demoProtocol],
                    ['Network Protocol', demo.header.networkProtocol],
                    ['Server Name', demo.header.serverName],
                    ['Client Name', demo.header.clientName],
                    ['Map Name', demo.header.mapName],
                    ['Game Directory', demo.header.gameDirectory],
                    ['Playback Time', formatTime(demo.header.playbackTime)],
                    ['Playback Ticks', demo.header.playbackTicks],
                    ['Playback Frames', demo.header.playbackFrames],
                    ['Sign On Length', demo.header.signOnLength]
                ];

                if (demo.adjustment.delta != 0) {
                    let adjustmentResult = getAdjustmentResult(demo);
                    header[7].push(adjustmentResult.time);
                    header[8].push(adjustmentResult.ticks);
                }

                let commands = [];
                let ipt = demo.intervalPerTick();
                demo.messages.forEach((msg) => {
                    if (msg.type == 0x04) {
                        commands.push([msg.tick, msg.message.command, formatTime(msg.tick * ipt)]);
                    }
                });

                infoHeader.innerHTML = demo.fileInfo.name;
                infoHeaderEntries.innerHTML = '';
                infoCommandsEntries.innerHTML = '';
                generateRows(infoHeaderEntries, header, false);
                generateRows(infoCommandsEntries, commands);
            } else {
                infoHeader.innerHTML = 'oof :(';
                infoHeaderEntries.innerHTML = '-';
                infoCommandsEntries.innerHTML = '-';
            }
        };
        var parseInfoFile = (file) => {
            demo = null;
            let fileInfo = {
                name: file.name
            };

            let reader = new FileReader();
            reader.onload = (ev) => {
                demo = tryParseDemo(ev);
                displayInfo();
            };
            reader.source = fileInfo;
            reader.readAsArrayBuffer(file);
        };

        // List Tab
        var demos = [];
        var sortByFileName = true;
        var infoListItem = (index) => {
            demo = demos[index];
            displayInfo();
            tabs.select('info');
            window.scrollTo(0, 0);
        };
        var viewListItem = (index) => {
            addView(demos[index]);
            tabs.select('view');
            window.scrollTo(0, 0);
            displayViewPlot();
        };
        var removeListItem = (index) => {
            demos = demos.filter(demo => demo != demos[index]);
            displayList();
        };
        var displayList = () => {
            listEntries.innerHTML = '';

            let curTicks = 0;
            let curTime = 0;
            let index = 0;

            if (sortByFileName) {
                demos = demos.sort((a, b) => a.fileInfo.name.localeCompare(b.fileInfo.name, undefined, { numeric: true }));
            } else {
                demos = demos.sort((a, b) => (a.fileInfo.index < b.fileInfo.index) ? -1 : 1);
            }

            for (let demo of demos) {
                curTicks += demo.header.playbackTicks;
                curTime += demo.header.playbackTime;

                let map = document.createElement('td');
                map.setAttribute('title', demo.fileInfo.name);
                let client = document.createElement('td');
                let ticks = document.createElement('td');
                let time = document.createElement('td');
                let totalTicks = document.createElement('td');
                let totalTime = document.createElement('td');
                let btnOptions = document.createElement('td');

                map.innerHTML = demo.header.mapName;
                client.innerHTML = demo.header.clientName;
                ticks.innerHTML = demo.header.playbackTicks;
                time.innerHTML = formatTime(demo.header.playbackTime);
                totalTicks.innerHTML = curTicks;
                totalTime.innerHTML = formatTime(curTime);
                btnOptions.innerHTML = `
                    <div class="btn-floating waves-effect waves-light green" title="View Info"
                        onclick="infoListItem(${index})">
                        <i class="material-icons">notes</i>
                    </div>
                    &nbsp;&nbsp;&nbsp;
                    <div class="btn-floating waves-effect waves-light green" title="Add To View"
                        onclick="viewListItem(${index})">
                        <i class="material-icons">show_chart</i>
                    </div>
                    &nbsp;&nbsp;&nbsp;
                    <div class="btn-floating waves-effect waves-light green" title="Remove Demo"
                        onclick="removeListItem(${index})">
                        <i class="material-icons">clear</i>
                    </div>`;

                if (demo.adjustment.delta != 0) {
                    let adjustmentResult = getAdjustmentResult(demo);
                    time.setAttribute('title', adjustmentResult.time);
                    ticks.setAttribute('title', adjustmentResult.ticks);
                }

                let entry = document.createElement('tr');
                entry.appendChild(map);
                entry.appendChild(client);
                entry.appendChild(ticks);
                entry.appendChild(time);
                entry.appendChild(totalTicks);
                entry.appendChild(totalTime);
                entry.appendChild(btnOptions);

                listEntries.appendChild(entry);
                ++index;
            }
        };
        var parseListFiles = (files) => {
            let count = 0;
            let index = demos.length;
            for (let file of files) {
                let fileInfo = {
                    index: index++,
                    name: file.name
                };

                let reader = new FileReader();
                reader.onload = (ev) => {
                    let demo = tryParseDemo(ev);
                    if (demo != null) {
                        demos.push(demo);
                    }

                    if (++count == files.length) {
                        displayList();
                    }
                };
                reader.source = fileInfo;
                reader.readAsArrayBuffer(file);
            }
        };

        // View Tab
        var views = [];
        var viewLayout = {
            margin: {
                l: 0,
                r: 0,
                b: 0,
                t: 33
            },
            scene: {
                aspectmode: 'data'
            },
            showlegend: true
        };
        var addView = (demo) => {
            if (demo == null) {
                return;
            }

            let view = {
                mode: 'lines',
                line: {
                    width: 3
                },
                type: 'scatter3d',
                name: demo.fileInfo.name,
                x: [],
                y: [],
                z: [],
                text: []
            };

            demo.messages.forEach((msg) => {
                if (msg.type == 0x02
                    && msg.message.packetInfo[0].viewOrigin[0].x != 0
                    && msg.message.packetInfo[0].viewOrigin[0].y != 0
                    && msg.message.packetInfo[0].viewOrigin[0].z != 0) {
                    view.x.push(msg.message.packetInfo[0].viewOrigin[0].x);
                    view.y.push(msg.message.packetInfo[0].viewOrigin[0].y);
                    view.z.push(msg.message.packetInfo[0].viewOrigin[0].z);
                    view.text.push(`Tick ${msg.tick}`);
                }
            });

            views.push(view);
        };
        var displayViewPlot = () => {
            Plotly.newPlot('view-plot', views, viewLayout, { responsive: true });
        };
        var parseViewFiles = (files) => {
            let count = 0;
            let index = 0;
            for (let file of files) {
                let fileInfo = {
                    index: index++,
                    name: file.name
                };

                let reader = new FileReader();
                reader.onload = (ev) => {
                    addView(tryParseDemo(ev, false));

                    if (++count == files.length) {
                        displayViewPlot();
                    }
                };
                reader.source = fileInfo;
                reader.readAsArrayBuffer(file);
            }
        };

        // Drag & Drop Support
        var dropHandler = (ev) => {
            ev.preventDefault();

            let files = [];

            if (ev.dataTransfer.items) {
                for (let i = 0; i < ev.dataTransfer.items.length; ++i) {
                    if (ev.dataTransfer.items[i].kind === 'file') {
                        files.push(ev.dataTransfer.items[i].getAsFile());
                    }
                }
            }

            if (files.length > 0) {
                switch (ev.target.parentElement.id) {
                    case 'info':
                        parseInfoFile(files[0]);
                        break;
                    case 'list':
                        parseListFiles(files);
                        break;
                    case 'view':
                        parseViewFiles(files);
                        break;
                }
            }

            removeDragData(ev)
        };
        var dragOverHandler = (ev) => {
            ev.preventDefault();
        };
        var removeDragData = (ev) => {
            if (ev.dataTransfer.items) {
                ev.dataTransfer.items.clear();
            } else {
                ev.dataTransfer.clearData();
            }
        };

        // Util
        var formatTime = (time) => {
            let sec = Math.floor(time);
            let ms = Math.ceil((time - sec) * 1000000)
                .toString()
                .padStart(6, '0')
                .slice(0, 3);

            if (sec >= 60) {
                let min = sec / 60;
                sec = sec % 60;
                if (min >= 60) {
                    let hrs = min / 60;
                    min = Math.floor(min % 60);
                    return `${Math.floor(hrs)}:${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}.${ms}`;
                }
                return `${Math.floor(min)}:${sec.toString().padStart(2, '0')}.${ms}`;
            }
            return `${Math.floor(sec)}.${ms}`;
        };

        // Event Listeners
        document.getElementById('add-info').addEventListener('change', (ev) => {
            let file = ev.target.files[0];
            if (file) {
                parseInfoFile(file);
            }
        });
        document.getElementById('add-info-view').addEventListener('click', (ev) => {
            if (demo == null) {
                return;
            }

            addView(demo);
            tabs.select('view');
            window.scrollTo(0, 0);
            displayViewPlot();
        });
        document.getElementById('add-list-item').addEventListener('change', (ev) => {
            let files = ev.target.files;
            if (files.length == 0) {
                return;
            }
            parseListFiles(files);
        });
        document.getElementById('clear-list').addEventListener('click', () => {
            demos = [];
            listEntries.innerHTML = '';
        });
        document.getElementById('save-list').addEventListener('click', () => {
            if (demos.length > 0) {
                var rows = ['Map,Client,Ticks,Time,Total Ticks,Total Time'];
                for (let row of listEntries.children) {
                    let items = [];
                    for (let i = 0; i < row.children.length - 2; ++i) {
                        items.push(row.children[i].innerHTML);
                    }
                    rows.push(items.join(','));
                }

                var data = new Blob([rows.join('\n')]);
                var save = document.createElement('a');
                save.setAttribute('href', window.URL.createObjectURL(data, { type: 'text/csv' }));
                save.setAttribute('download', 'demo_list.csv');
                save.click();
            }
        });
        document.getElementById('change-sort-list-method').addEventListener('change', (ev) => {
            sortByFileName = ev.target.checked;
            displayList();
        });
        document.getElementById('add-view').addEventListener('change', (ev) => {
            let files = ev.target.files;
            if (files.length == 0) {
                return;
            }
            parseViewFiles(files);
        });
        document.getElementById('clear-view').addEventListener('click', (ev) => {
            let view = {
                mode: 'lines',
                line: {
                    width: 3
                },
                type: 'scatter3d',
                x: [],
                y: [],
                z: [],
                text: []
            };
            views = [];
            views.push(view);
            displayViewPlot();
        });
    </script>
</body>

</html>